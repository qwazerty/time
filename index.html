<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Heure locale avec fuseau</title>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #000;
      --control-bg: #fff;
      --control-text: #000;
      --control-border: #ccc;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --control-bg: #2a2a2a;
      --control-text: #fff;
      --control-border: #444;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Helvetica Neue', sans-serif;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 1em;
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 2em;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.2em;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    #theme-toggle:hover {
      transform: scale(1.1);
    }

    #theme-toggle:active {
      transform: scale(0.95);
    }

    #time {
      font-size: 14em;
      font-weight: bold;
      line-height: 1;
      margin: 0;
    }
    #date, #week {
      font-size: 5em;
      margin: 0.3em 0;
    }
    #controls {
      margin-top: 1em;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    select {
      font-size: 1em;
      padding: 0.2em;
      margin: 0.2em;
      max-width: 90vw;
      width: auto;
      background-color: var(--control-bg);
      color: var(--control-text);
      border: 1px solid var(--control-border);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    label {
      font-size: 1em;
    }

    /* Media query pour petits Ã©crans (largeur â‰¤ 600px) */
    @media (max-width: 600px) {
      #time {
        font-size: 6em;
      }
      #date, #week {
        font-size: 2em;
      }
      #theme-toggle {
        font-size: 1.5em;
        top: 10px;
        right: 10px;
      }
      label {
        font-size: 0.9em;
      }
      select {
        font-size: 0.9em;
        padding: 0.25em;
      }
    }

    /* Media query pour trÃ¨s petits Ã©crans (largeur â‰¤ 350px) */
    @media (max-width: 350px) {
      #time {
        font-size: 4.5em;
      }
      #date, #week {
        font-size: 1.5em;
      }
      #theme-toggle {
        font-size: 1.2em;
      }
      label {
        font-size: 0.8em;
      }
      select {
        font-size: 0.8em;
        padding: 0.2em;
      }
    }
  </style>
</head>
<body>
  <!-- Theme toggle button -->
  <button id="theme-toggle" aria-label="Toggle dark mode">ðŸŒ™</button>

  <!-- Affichage du temps, date et semaine -->
  <div id="time">--:--:--</div>
  <div id="date">---</div>
  <div id="week">Semaine --</div>

  <!-- SÃ©lecteur de fuseaux horaires (placÃ© en bas) -->
  <div id="controls">
    <label for="timezone-select">Fuseau horaire : </label>
    <select id="timezone-select"></select>
  </div>

  <script>
    // RÃ©cupÃ¨re toutes les zones IANA disponibles via l'API Intl
    let TIMEZONES = [];
    if (typeof Intl.supportedValuesOf === 'function') {
      TIMEZONES = Intl.supportedValuesOf('timeZone');
    } else {
      // Fallback minimal au cas oÃ¹ le navigateur n'implÃ©mente pas supportedValuesOf
      TIMEZONES = [
        "UTC", "Europe/Paris", "Europe/London", "America/New_York",
        "America/Los_Angeles", "Asia/Tokyo", "Australia/Sydney"
      ];
    }
    // Trie alphabÃ©tiquement pour faciliter la recherche
    TIMEZONES.sort((a, b) => a.localeCompare(b));

    // Lit le paramÃ¨tre 'tz' dans l'URL (ex. ?tz=Europe/Paris)
    function getTimezoneFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const tz = params.get("tz");
      if (tz && TIMEZONES.includes(tz)) {
        return tz;
      }
      return null;
    }

    // Met Ã  jour le paramÃ¨tre 'tz' dans l'URL sans recharger la page
    function updateQueryParam(tz) {
      const url = new URL(window.location);
      url.searchParams.set("tz", tz);
      window.history.replaceState({}, "", url.toString());
    }

    // Lit le paramÃ¨tre 'theme' dans l'URL (ex. ?theme=dark)
    function getThemeFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const theme = params.get("theme");
      if (theme === "dark" || theme === "light") {
        return theme;
      }
      return null;
    }

    // Met Ã  jour le paramÃ¨tre 'theme' dans l'URL sans recharger la page
    function updateThemeQueryParam(theme) {
      const url = new URL(window.location);
      url.searchParams.set("theme", theme);
      window.history.replaceState({}, "", url.toString());
    }

    // Calcule le numÃ©ro de semaine ISO (1â€“53) pour une date UTC
    function getWeekNumberUTC(dateObjUTC) {
      const d = new Date(Date.UTC(
        dateObjUTC.getUTCFullYear(),
        dateObjUTC.getUTCMonth(),
        dateObjUTC.getUTCDate()
      ));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // RÃ©cupÃ¨re les composantes (annÃ©e, mois, jour, heures, minutes, secondes)
    // d'une Date "rÃ©elle" (locale) en fonction d'un fuseau donnÃ©.
    function getPartsInZone(date, tz) {
      const fmt = new Intl.DateTimeFormat('en-GB', {
        timeZone: tz,
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: false
      });
      const parts = fmt.formatToParts(date);
      const obj = {};
      parts.forEach(p => {
        if (p.type !== 'literal') {
          obj[p.type] = parseInt(p.value, 10);
        }
      });
      return {
        year: obj.year,
        month: obj.month,
        day: obj.day,
        hour: obj.hour,
        minute: obj.minute,
        second: obj.second
      };
    }

    // Met Ã  jour l'horloge selon le fuseau sÃ©lectionnÃ©
    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('fr-FR', {
        hour12: false,
        timeZone: currentTz
      });
      const dateString = now.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        timeZone: currentTz
      });
      const parts = getPartsInZone(now, currentTz);
      const utcForWeek = new Date(Date.UTC(parts.year, parts.month - 1, parts.day));
      const weekNum = getWeekNumberUTC(utcForWeek);

      document.getElementById('time').textContent = timeString;
      document.getElementById('date').textContent = dateString;
      document.getElementById('week').textContent = `Semaine ${weekNum}`;
    }

    // Theme management
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeQueryParam(theme);
      const toggleBtn = document.getElementById('theme-toggle');
      toggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    }

    function initializeTheme() {
      // Priority: URL param â†’ localStorage â†’ system preference â†’ light
      const urlTheme = getThemeFromQuery();
      const storedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      let theme = 'light';
      if (urlTheme) {
        theme = urlTheme;
      } else if (storedTheme) {
        theme = storedTheme;
      } else if (prefersDark) {
        theme = 'dark';
      }
      
      setTheme(theme);
    }

    // Initialisation du fuseau : query param > fuseau systÃ¨me > UTC
    let currentTz = getTimezoneFromQuery() ||
                    Intl.DateTimeFormat().resolvedOptions().timeZone ||
                    "UTC";

    // Remplissage de la liste dÃ©roulante avec toutes les zones
    const select = document.getElementById('timezone-select');
    TIMEZONES.forEach(zone => {
      const opt = document.createElement('option');
      opt.value = zone;
      // Remplace '_' par ' ' pour l'affichage
      opt.textContent = zone.replace(/_/g, ' ');
      if (zone === currentTz) {
        opt.selected = true;
      }
      select.appendChild(opt);
    });

    // Quand on change de fuseau via la liste dÃ©roulante
    select.addEventListener('change', e => {
      const chosenTz = e.target.value;
      if (TIMEZONES.includes(chosenTz)) {
        currentTz = chosenTz;
        updateQueryParam(chosenTz);
        updateClock();
      }
    });

    // Theme toggle button event listener
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    });

    // Initialize theme
    initializeTheme();

    // Lancement du minuteur et mise Ã  jour immÃ©diate
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
